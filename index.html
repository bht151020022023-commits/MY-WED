<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Web cá»§a Há»¯u Thiá»‡n</title>

<style>
body{font-family:Arial;text-align:center;margin-top:30px;background:#f4f6f9;}
button{padding:8px 14px;margin:5px;border:none;border-radius:8px;cursor:pointer;}
.btn-main{background:#2196F3;color:white;}
.btn-add{background:#4CAF50;color:white;}
.btn-undo{background:#ff9800;color:white;}
.box{width:65%;margin:auto;margin-top:15px;background:white;padding:12px;border-radius:8px;box-shadow:0 0 8px rgba(0,0,0,0.1);text-align:left;}
input{padding:6px;margin:5px;}
.hidden{display:none;}
.slideBox{max-height:0;overflow:hidden;transition:max-height 0.4s ease;}
.slideBox.active{max-height:900px;}
.progress{background:#ddd;height:10px;border-radius:5px;}
.progress-bar{height:10px;border-radius:5px;background:green;}
</style>
</head>
<body>

<div id="loginScreen" style="margin-top:100px;">
<h2>ğŸ” Nháº­p máº­t kháº©u</h2>
<input type="password" id="passwordInput">
<br><br>
<button onclick="checkPassword()">ÄÄƒng nháº­p</button>
<p id="loginError" style="color:red;"></p>
</div>

<div id="appContent" style="display:none;">
<h2>ğŸ”¥ Web cá»§a Há»¯u Thiá»‡n</h2>
<p style="color:gray;">Há»‡ thá»‘ng theo dÃµi cÃ¡ nhÃ¢n ğŸš¬ğŸƒ</p>
<button onclick="logout()">ğŸšª ÄÄƒng xuáº¥t</button>
<br><br>

<button id="smokeBtn" class="btn-main">ğŸš¬ HÃºt thuá»‘c</button>
<button id="runBtn" class="btn-main">ğŸƒ Cháº¡y bá»™</button>

<div id="smokeBox" class="hidden box"></div>
<div id="runBox" class="hidden box"></div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDFgBUsVGUWoj-b2qGj4DyUpALlch2MSQ",
  authDomain: "bhtz-a7f60.firebaseapp.com",
  projectId: "bhtz-a7f60",
  storageBucket: "bhtz-a7f60.firebasestorage.app",
  messagingSenderId: "708884006477",
  appId: "1:708884006477:web:de2a3e37f6513d6676be04"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data={};

/* PASSWORD */
const PASS="15102002";
function checkPassword(){
 if(passwordInput.value===PASS){
  localStorage.setItem("auth","true");
  showApp();
 }else loginError.innerText="Sai máº­t kháº©u!";
}
function showApp(){loginScreen.style.display="none";appContent.style.display="block";}
function logout(){localStorage.removeItem("auth");location.reload();}
window.checkPassword=checkPassword;
window.logout=logout;

/* FIRESTORE */
async function loadData(){
 const snap=await getDoc(doc(db,"tracker","main"));
 if(snap.exists()) data=snap.data();
 if(!data.smoke) data.smoke={};
 if(!data.run) data.run={};
 renderSmoke();
 renderRun();
}
async function saveData(){
 await setDoc(doc(db,"tracker","main"),data);
}
/* ================= SMOKE ================= */

function renderSmoke(){
 smokeBox.innerHTML=`
 <h3>ğŸš¬ HÃºt thuá»‘c</h3>
 <input type="date" id="smokeDate">
 <button class="btn-add" onclick="addSmoke()">ThÃªm</button>
 <button class="btn-undo" onclick="undoSmoke()">HoÃ n tÃ¡c</button>

 <br><br>
 <input type="month" id="smokeMonth">
 <button onclick="toggleSmokeMonth()">ğŸ“Š Thá»‘ng kÃª thÃ¡ng</button>

 <div id="smokeContent"></div>
 <div id="smokeMonthBox" class="slideBox"></div>
 `;
 smokeDate.value=new Date().toISOString().split("T")[0];
 updateSmokeUI();
}

function addSmoke(){
 let d=smokeDate.value;
 if(!data.smoke[d]) data.smoke[d]={count:0,history:[]};
 data.smoke[d].count++;
 data.smoke[d].history.unshift(new Date().toLocaleTimeString());
 saveData();updateSmokeUI();
}

function undoSmoke(){
 let d=smokeDate.value;
 if(data.smoke[d]?.count>0){
  data.smoke[d].count--;
  data.smoke[d].history.shift();
  saveData();updateSmokeUI();
 }
}

function updateSmokeUI(){
 let d=smokeDate.value;
 let html=`<h4>${d}: ${data.smoke[d]?.count||0} láº§n</h4>`;
 if(data.smoke[d]){
  data.smoke[d].history.forEach((t,i)=>{
   html+=`<div>Láº§n ${data.smoke[d].history.length-i} - ${t}</div>`;
  });
 }
 smokeContent.innerHTML=`<div id="smokeDayBox">${html}</div>`;
}

function toggleSmokeMonth(){
 smokeMonthBox.classList.toggle("active");
 smokeDayBox.style.display=smokeMonthBox.classList.contains("active")?"none":"block";
 updateSmokeMonth();
}

function updateSmokeMonth(){
 let m=smokeMonth.value;if(!m) return;
 let total=0,html=`<h4>ğŸ”¥ ThÃ¡ng ${m}</h4>`;
 for(let d in data.smoke){
  if(d.startsWith(m)){
   html+=`<div>ğŸ“… ${d}: ${data.smoke[d].count} láº§n</div>`;
   total+=data.smoke[d].count;
  }
 }

 let goal=parseInt(localStorage.getItem("smokeGoal")||40);
 let percent=Math.min((total/goal)*100,100);

 html+=`
 <hr><strong>Tá»•ng: ${total} láº§n</strong><br>
 ğŸ¯ Má»¥c tiÃªu â‰¤ ${goal} láº§n<br>
 <div class="progress"><div class="progress-bar" style="width:${percent}%"></div></div>
 <br><input type="number" id="newSmokeGoal" placeholder="Má»¥c tiÃªu má»›i">
 <button onclick="setSmokeGoal()">LÆ°u</button>
 `;
 smokeMonthBox.innerHTML=html;
}

function setSmokeGoal(){
 localStorage.setItem("smokeGoal",newSmokeGoal.value);
 updateSmokeMonth();
}

window.addSmoke=addSmoke;
window.undoSmoke=undoSmoke;
window.toggleSmokeMonth=toggleSmokeMonth;
window.setSmokeGoal=setSmokeGoal;
/* ================= RUN ================= */

function renderRun(){
 runBox.innerHTML=`
 <h3>ğŸƒ Cháº¡y bá»™</h3>
 <input type="date" id="runDate"><br>
 <input type="number" id="kmInput" placeholder="Km">
 <input type="number" id="hourInput" placeholder="Giá»">
 <input type="number" id="minuteInput" placeholder="PhÃºt">
 <button class="btn-add" onclick="addRun()">LÆ°u</button>
 <button class="btn-undo" onclick="undoRun()">HoÃ n tÃ¡c</button>

 <br><br>
 <input type="month" id="runMonth">
 <button onclick="toggleRunMonth()">ğŸ“Š Thá»‘ng kÃª thÃ¡ng</button>

 <div id="runContent"></div>
 <div id="runMonthBox" class="slideBox"></div>
 `;
 runDate.value=new Date().toISOString().split("T")[0];
 updateRunUI();
}

function addRun(){
 let d=runDate.value;
 if(!data.run[d]) data.run[d]={sessions:[]};
 data.run[d].sessions.unshift({
  km:parseFloat(kmInput.value)||0,
  hour:parseInt(hourInput.value)||0,
  minute:parseInt(minuteInput.value)||0,
  time:new Date().toLocaleTimeString()
 });
 saveData();updateRunUI();
}

function undoRun(){
 let d=runDate.value;
 if(data.run[d]?.sessions.length>0){
  data.run[d].sessions.shift();
  saveData();updateRunUI();
 }
}

function updateRunUI(){
 let d=runDate.value;
 let totalKm=0,totalMin=0,html="";
 if(data.run[d]){
  data.run[d].sessions.forEach(s=>{
   totalKm+=s.km;
   totalMin+=s.hour*60+s.minute;
  });
  let h=Math.floor(totalMin/60),m=totalMin%60;
  html+=`<h4>${d}: ${totalKm} km | ${h}h ${m}p</h4>`;
  data.run[d].sessions.forEach((s,i)=>{
   html+=`<div>Buá»•i ${data.run[d].sessions.length-i} - ${s.km}km | ${s.hour}h ${s.minute}p | ${s.time}</div>`;
  });
 }
 runContent.innerHTML=`<div id="runDayBox">${html}</div>`;
}
function toggleRunMonth(){
 runMonthBox.classList.toggle("active");
 runDayBox.style.display=runMonthBox.classList.contains("active")?"none":"block";
 updateRunMonth();
}

function updateRunMonth(){
 let m=runMonth.value;if(!m) return;
 let totalKm=0,totalMin=0,days=[];
 for(let d in data.run){
  if(d.startsWith(m)){
   let dayKm=0,dayMin=0;
   data.run[d].sessions.forEach(s=>{
    dayKm+=s.km;dayMin+=s.hour*60+s.minute;
   });
   if(dayKm>0) days.push(d);
   totalKm+=dayKm;totalMin+=dayMin;
  }
 }

 days.sort();
 let streak=0;
 let today=new Date();
 for(let i=days.length-1;i>=0;i--){
  let diff=(today-new Date(days[i]))/(1000*60*60*24);
  if(diff<=streak+1) streak++; else break;
 }

 let H=Math.floor(totalMin/60),M=totalMin%60;
 let goal=parseInt(localStorage.getItem("runGoal")||100);
 let percent=Math.min((totalKm/goal)*100,100);

 runMonthBox.innerHTML=`
 <h4>ğŸ”¥ ThÃ¡ng ${m}</h4>
 <strong>Tá»•ng: ${totalKm} km | ${H}h ${M}p</strong><br>
 ğŸ”¥ Streak: ${streak} ngÃ y<br><br>
 ğŸ¯ Má»¥c tiÃªu ${goal} km<br>
 <div class="progress"><div class="progress-bar" style="width:${percent}%"></div></div>
 <br><input type="number" id="newRunGoal" placeholder="Má»¥c tiÃªu km">
 <button onclick="setRunGoal()">LÆ°u</button>
 `;
}

function setRunGoal(){
 localStorage.setItem("runGoal",newRunGoal.value);
 updateRunMonth();
}

window.addRun=addRun;
window.undoRun=undoRun;
window.toggleRunMonth=toggleRunMonth;
window.setRunGoal=setRunGoal;

/* TOGGLE BUTTONS */
smokeBtn.onclick=()=>smokeBox.classList.toggle("hidden");
runBtn.onclick=()=>runBox.classList.toggle("hidden");

/* INIT */
window.onload=async()=>{
 if(localStorage.getItem("auth")==="true") showApp();
 await loadData();
};
</script></body></html>
