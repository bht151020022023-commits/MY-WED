<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Web cá»§a Há»¯u Thiá»‡n</title>

<style>
*{box-sizing:border-box;}

body{
 font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
 background:#0f0f0f;
 color:white;
 margin:0;
 padding:20px 10px;
 text-align:center;
}

h2{margin-top:10px;font-size:22px;}

button{
 padding:12px 16px;
 margin:6px 4px;
 border:none;
 border-radius:12px;
 cursor:pointer;
 font-weight:600;
 font-size:15px;
}

.btn-main{background:#2196F3;color:white;}
.btn-add{background:#2ecc71;color:black;}
.btn-undo{background:#e67e22;color:black;}

button:active{transform:scale(0.96);}

.box{
 width:100%;
 max-width:700px;
 margin:15px auto;
 background:#1a1a1a;
 padding:16px;
 border-radius:16px;
 border:1px solid #2a2a2a;
 text-align:left;
}

input{
 width:100%;
 padding:12px;
 margin:6px 0;
 background:#121212;
 border:1px solid #333;
 color:white;
 border-radius:10px;
 font-size:15px;
}

.hidden{display:none;}

.slide{
 max-height:0;
 overflow:hidden;
 transition:max-height .35s ease;
}
.slide.active{max-height:3000px;}

.progress{
 background:#333;
 height:8px;
 border-radius:6px;
 margin-top:6px;
}
.progress-bar{
 height:8px;
 border-radius:6px;
 background:#2ecc71;
}

@media (max-width:600px){
 button{width:100%;}
}
</style>
</head>
<body>

<div id="login">
<h2>ğŸ” Nháº­p máº­t kháº©u</h2>
<input type="password" id="passInput">
<br>
<button id="loginBtn">ÄÄƒng nháº­p</button>
<p id="loginError" style="color:red;"></p>
</div>

<div id="app" class="hidden">
<h2>ğŸ”¥ Web cá»§a Há»¯u Thiá»‡n</h2>
<button id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</button>

<button class="btn-main" id="smokeToggle">ğŸš¬ HÃºt thuá»‘c</button>
<button class="btn-main" id="runToggle">ğŸƒ Cháº¡y bá»™</button>

<div id="smokeBox" class="box hidden"></div>
<div id="runBox" class="box hidden"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* DOM */
const loginDiv=document.getElementById("login");
const appDiv=document.getElementById("app");
const passInput=document.getElementById("passInput");
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const smokeToggle=document.getElementById("smokeToggle");
const runToggle=document.getElementById("runToggle");
const smokeBox=document.getElementById("smokeBox");
const runBox=document.getElementById("runBox");

/* FIREBASE */
const firebaseConfig={
 apiKey:"AIzaSyDFgBUsVGUWoj-b2qGj4DyUpALlch2MSQ",
 authDomain:"bhtz-a7f60.firebaseapp.com",
 projectId:"bhtz-a7f60",
 storageBucket:"bhtz-a7f60.firebasestorage.app",
 messagingSenderId:"708884006477",
 appId:"1:708884006477:web:de2a3e37f6513d6676be04"
};
const appFB=initializeApp(firebaseConfig);
const db=getFirestore(appFB);

let data={smoke:{},run:{}};
const PASS="15102002";

/* AUTH */
loginBtn.onclick=()=>{
 if(passInput.value===PASS){
  localStorage.setItem("auth","true");
  loginDiv.classList.add("hidden");
  appDiv.classList.remove("hidden");
 }else document.getElementById("loginError").innerText="Sai máº­t kháº©u!";
};

logoutBtn.onclick=()=>{
 localStorage.removeItem("auth");
 location.reload();
};

smokeToggle.onclick=()=>smokeBox.classList.toggle("hidden");
runToggle.onclick=()=>runBox.classList.toggle("hidden");

/* FIRESTORE */
async function loadData(){
 const snap=await getDoc(doc(db,"tracker","main"));
 if(snap.exists()) data=snap.data();
 if(!data.smoke) data.smoke={};
 if(!data.run) data.run={};
 renderSmoke();
 renderRun();
}

async function saveData(){
 await setDoc(doc(db,"tracker","main"),data);
}

/* ============ SMOKE ============ */

function renderSmoke(){
 smokeBox.innerHTML=`
 <h3>ğŸš¬ HÃºt thuá»‘c</h3>
 <input type="date" id="smokeDate">
 <button class="btn-add" onclick="addSmoke()">ThÃªm</button>
 <button class="btn-undo" onclick="undoSmoke()">HoÃ n tÃ¡c</button>
 <br>
 <input type="month" id="smokeMonth">
 <button onclick="toggleSmokeMonth()">ğŸ“Š Thá»‘ng kÃª thÃ¡ng</button>
 <div id="smokeDay"></div>
 <div id="smokeMonthBox" class="slide"></div>
 `;
 document.getElementById("smokeDate").value=new Date().toISOString().split("T")[0];
 updateSmokeDay();
}

window.addSmoke=function(){
 const d=document.getElementById("smokeDate").value;
 if(!data.smoke[d]) data.smoke[d]={count:0,history:[]};
 data.smoke[d].count++;
 data.smoke[d].history.unshift(new Date().toLocaleTimeString());
 saveData();updateSmokeDay();
}

window.undoSmoke=function(){
 const d=document.getElementById("smokeDate").value;
 if(data.smoke[d]?.count>0){
  data.smoke[d].count--;
  data.smoke[d].history.shift();
  saveData();updateSmokeDay();
 }
}

function updateSmokeDay(){
 const d=document.getElementById("smokeDate").value;
 let html=`<h4>${d}: ${data.smoke[d]?.count||0} láº§n</h4>`;
 if(data.smoke[d]){
  data.smoke[d].history.forEach((t,i)=>{
   html+=`<div>Láº§n ${data.smoke[d].history.length-i} - ${t}</div>`;
  });
 }
 document.getElementById("smokeDay").innerHTML=html;
}

window.toggleSmokeMonth=function(){
 const box=document.getElementById("smokeMonthBox");
 const day=document.getElementById("smokeDay");
 box.classList.toggle("active");
 day.style.display=box.classList.contains("active")?"none":"block";
 updateSmokeMonth();
}

function updateSmokeMonth(){
 const m=document.getElementById("smokeMonth").value;
 if(!m)return;

 let total=0;
 let html=`<h4>ğŸ”¥ ThÃ¡ng ${m}</h4>`;

 Object.keys(data.smoke).forEach(d=>{
  if(d.startsWith(m)){
   total+=data.smoke[d].count;
   html+=`<div>ğŸ“… ${d}: ${data.smoke[d].count} láº§n</div>`;
  }
 });

 let goal=parseInt(localStorage.getItem("smokeGoal")||50);
 let percent=Math.min((total/goal)*100,100);

 html+=`
 <hr>
 <strong>Tá»•ng: ${total} láº§n</strong><br>
 ğŸ¯ Má»¥c tiÃªu â‰¤ ${goal}
 <div class="progress"><div class="progress-bar" style="width:${percent}%"></div></div>
 <br>
 <input type="number" id="newSmokeGoal" placeholder="Má»¥c tiÃªu má»›i">
 <button onclick="setSmokeGoal()">LÆ°u</button>
 `;
 document.getElementById("smokeMonthBox").innerHTML=html;
}

window.setSmokeGoal=function(){
 const val=document.getElementById("newSmokeGoal").value;
 if(val>0){
  localStorage.setItem("smokeGoal",val);
  updateSmokeMonth();
 }
}

/* ============ RUN ============ */

function renderRun(){
 runBox.innerHTML=`
 <h3>ğŸƒ Cháº¡y bá»™</h3>
 <input type="date" id="runDate">
 <input type="number" id="kmInput" placeholder="Km">
 <input type="number" id="hInput" placeholder="Giá»">
 <input type="number" id="mInput" placeholder="PhÃºt">
 <button class="btn-add" onclick="addRun()">LÆ°u</button>
 <button class="btn-undo" onclick="undoRun()">HoÃ n tÃ¡c</button>
 <br>
 <input type="month" id="runMonth">
 <button onclick="toggleRunMonth()">ğŸ“Š Thá»‘ng kÃª thÃ¡ng</button>
 <div id="runDay"></div>
 <div id="runMonthBox" class="slide"></div>
 `;
 document.getElementById("runDate").value=new Date().toISOString().split("T")[0];
 updateRunDay();
}

window.addRun=function(){
 const d=document.getElementById("runDate").value;
 if(!data.run[d]) data.run[d]={sessions:[]};
 data.run[d].sessions.unshift({
  km:+document.getElementById("kmInput").value||0,
  h:+document.getElementById("hInput").value||0,
  m:+document.getElementById("mInput").value||0
 });
 saveData();updateRunDay();
}

window.undoRun=function(){
 const d=document.getElementById("runDate").value;
 if(data.run[d]?.sessions.length>0){
  data.run[d].sessions.shift();
  saveData();updateRunDay();
 }
}

function updateRunDay(){
 const d=document.getElementById("runDate").value;
 let totalKm=0,totalMin=0;
 if(data.run[d]){
  data.run[d].sessions.forEach(s=>{
   totalKm+=s.km;
   totalMin+=s.h*60+s.m;
  });
 }
 let H=Math.floor(totalMin/60),M=totalMin%60;
 document.getElementById("runDay").innerHTML=
 `<h4>${d}: ${totalKm} km | ${H}h ${M}p</h4>`;
}

window.toggleRunMonth=function(){
 const box=document.getElementById("runMonthBox");
 const day=document.getElementById("runDay");
 box.classList.toggle("active");
 day.style.display=box.classList.contains("active")?"none":"block";
 updateRunMonth();
}

function updateRunMonth(){
 const m=document.getElementById("runMonth").value;
 if(!m)return;

 let totalKm=0,totalMin=0;
 let html=`<h4>ğŸ”¥ ThÃ¡ng ${m}</h4>`;

 Object.keys(data.run).forEach(d=>{
  if(d.startsWith(m)){
   let dayKm=0,dayMin=0;
   data.run[d].sessions.forEach(s=>{
    dayKm+=s.km;
    dayMin+=s.h*60+s.m;
   });
   totalKm+=dayKm;
   totalMin+=dayMin;
   let H=Math.floor(dayMin/60),M=dayMin%60;
   html+=`<div>ğŸ“… ${d}: ${dayKm} km | ${H}h ${M}p</div>`;
  }
 });

 let H=Math.floor(totalMin/60),M=totalMin%60;
 let goal=parseInt(localStorage.getItem("runGoal")||100);
 let percent=Math.min((totalKm/goal)*100,100);

 html+=`
 <hr>
 <strong>Tá»•ng: ${totalKm} km | ${H}h ${M}p</strong><br>
 ğŸ¯ Má»¥c tiÃªu ${goal} km
 <div class="progress"><div class="progress-bar" style="width:${percent}%"></div></div>
 <br>
 <input type="number" id="newRunGoal" placeholder="Má»¥c tiÃªu km">
 <button onclick="setRunGoal()">LÆ°u</button>
 `;
 document.getElementById("runMonthBox").innerHTML=html;
}

window.setRunGoal=function(){
 const val=document.getElementById("newRunGoal").value;
 if(val>0){
  localStorage.setItem("runGoal",val);
  updateRunMonth();
 }
}

/* INIT */
window.onload=async()=>{
 if(localStorage.getItem("auth")==="true"){
  loginDiv.classList.add("hidden");
  appDiv.classList.remove("hidden");
 }
 await loadData();
};
</script>
</body>
</html>
