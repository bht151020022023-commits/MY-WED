<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Web cá»§a Há»¯u Thiá»‡n</title>

<style>
body{
 font-family:Arial;
 background:#0f0f0f;
 color:white;
 text-align:center;
 margin:0;
 padding:30px 0;
}
button{
 padding:8px 14px;
 margin:5px;
 border:none;
 border-radius:8px;
 cursor:pointer;
 font-weight:bold;
}
.btn-main{background:#2196F3;color:white;}
.btn-add{background:#2ecc71;color:black;}
.btn-undo{background:#e67e22;color:black;}
.box{
 width:70%;
 margin:15px auto;
 background:#1a1a1a;
 padding:15px;
 border-radius:12px;
 border:1px solid #333;
 text-align:left;
}
input{
 padding:6px;
 margin:5px;
 background:#121212;
 border:1px solid #333;
 color:white;
 border-radius:6px;
}
.hidden{display:none;}
.slide{max-height:0;overflow:hidden;transition:max-height .4s ease;}
.slide.active{max-height:2000px;}
.progress{background:#333;height:8px;border-radius:5px;}
.progress-bar{height:8px;border-radius:5px;background:#2ecc71;}
</style>
</head>
<body>

<div id="login">
<h2>ğŸ” Nháº­p máº­t kháº©u</h2>
<input type="password" id="passInput">
<br><br>
<button id="loginBtn">ÄÄƒng nháº­p</button>
<p id="loginError" style="color:red;"></p>
</div>

<div id="app" class="hidden">
<h2>ğŸ”¥ Web cá»§a Há»¯u Thiá»‡n</h2>
<button id="logoutBtn">ğŸšª ÄÄƒng xuáº¥t</button>
<br><br>

<button class="btn-main" id="smokeToggle">ğŸš¬ HÃºt thuá»‘c</button>
<button class="btn-main" id="runToggle">ğŸƒ Cháº¡y bá»™</button>

<div id="smokeBox" class="box hidden"></div>
<div id="runBox" class="box hidden"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* DOM */
const loginDiv=document.getElementById("login");
const appDiv=document.getElementById("app");
const passInput=document.getElementById("passInput");
const loginBtn=document.getElementById("loginBtn");
const logoutBtn=document.getElementById("logoutBtn");
const smokeToggle=document.getElementById("smokeToggle");
const runToggle=document.getElementById("runToggle");
const smokeBox=document.getElementById("smokeBox");
const runBox=document.getElementById("runBox");

/* FIREBASE */
const firebaseConfig={
 apiKey:"AIzaSyDFgBUsVGUWoj-b2qGj4DyUpALlch2MSQ",
 authDomain:"bhtz-a7f60.firebaseapp.com",
 projectId:"bhtz-a7f60",
 storageBucket:"bhtz-a7f60.firebasestorage.app",
 messagingSenderId:"708884006477",
 appId:"1:708884006477:web:de2a3e37f6513d6676be04"
};
const appFB=initializeApp(firebaseConfig);
const db=getFirestore(appFB);

let data={smoke:{},run:{}};
const PASS="15102002";

/* AUTH */
loginBtn.onclick=()=>{
 if(passInput.value===PASS){
  localStorage.setItem("auth","true");
  loginDiv.classList.add("hidden");
  appDiv.classList.remove("hidden");
 }else document.getElementById("loginError").innerText="Sai máº­t kháº©u!";
};
logoutBtn.onclick=()=>{
 localStorage.removeItem("auth");
 location.reload();
};

smokeToggle.onclick=()=>smokeBox.classList.toggle("hidden");
runToggle.onclick=()=>runBox.classList.toggle("hidden");

/* FIRESTORE */
async function loadData(){
 const snap=await getDoc(doc(db,"tracker","main"));
 if(snap.exists()) data=snap.data();
 if(!data.smoke) data.smoke={};
 if(!data.run) data.run={};
 renderSmoke();
 renderRun();
}
async function saveData(){
 await setDoc(doc(db,"tracker","main"),data);
}

/* ================= SMOKE ================= */

function renderSmoke(){
 smokeBox.innerHTML=`
 <h3>ğŸš¬ HÃºt thuá»‘c</h3>
 <input type="date" id="smokeDate">
 <button class="btn-add" id="addSmokeBtn">ThÃªm</button>
 <button class="btn-undo" id="undoSmokeBtn">HoÃ n tÃ¡c</button>
 <br><br>
 <input type="month" id="smokeMonth">
 <button id="smokeMonthBtn">ğŸ“Š Thá»‘ng kÃª thÃ¡ng</button>
 <div id="smokeDay"></div>
 <div id="smokeMonthBox" class="slide"></div>
 `;
 document.getElementById("smokeDate").value=new Date().toISOString().split("T")[0];
 document.getElementById("addSmokeBtn").onclick=addSmoke;
 document.getElementById("undoSmokeBtn").onclick=undoSmoke;
 document.getElementById("smokeMonthBtn").onclick=toggleSmokeMonth;
 updateSmokeDay();
}

function addSmoke(){
 const d=document.getElementById("smokeDate").value;
 if(!data.smoke[d]) data.smoke[d]={count:0,history:[]};
 data.smoke[d].count++;
 data.smoke[d].history.unshift(new Date().toLocaleTimeString());
 saveData();updateSmokeDay();
}

function undoSmoke(){
 const d=document.getElementById("smokeDate").value;
 if(data.smoke[d]?.count>0){
  data.smoke[d].count--;
  data.smoke[d].history.shift();
  saveData();updateSmokeDay();
 }
}

function updateSmokeDay(){
 const d=document.getElementById("smokeDate").value;
 let html=`<h4>${d}: ${data.smoke[d]?.count||0} láº§n</h4>`;
 if(data.smoke[d]){
  data.smoke[d].history.forEach((t,i)=>{
   html+=`<div>Láº§n ${data.smoke[d].history.length-i} - ${t}</div>`;
  });
 }
 document.getElementById("smokeDay").innerHTML=html;
}

function toggleSmokeMonth(){
 const box=document.getElementById("smokeMonthBox");
 const day=document.getElementById("smokeDay");

 box.classList.toggle("active");

 if(box.classList.contains("active")){
  day.style.display="none";
 }else{
  day.style.display="block";
 }

 updateSmokeMonth();
}

function updateSmokeMonth(){
 const m=document.getElementById("smokeMonth").value;
 if(!m) return;
 let total=0,html=`<h4>ğŸ”¥ ThÃ¡ng ${m}</h4>`;
 Object.keys(data.smoke).forEach(d=>{
  if(d.startsWith(m)){
   total+=data.smoke[d].count;
   html+=`<div>${d}: ${data.smoke[d].count} láº§n</div>`;
  }
 });
 const goal=parseInt(localStorage.getItem("smokeGoal")||50);
 const percent=Math.min((total/goal)*100,100);
 html+=`
 <hr>Tá»•ng: ${total} láº§n<br>
 ğŸ¯ Má»¥c tiÃªu â‰¤ ${goal}
 <div class="progress"><div class="progress-bar" style="width:${percent}%"></div></div>
 `;
 document.getElementById("smokeMonthBox").innerHTML=html;
}

/* ================= RUN ================= */

function renderRun(){
 runBox.innerHTML=`
 <h3>ğŸƒ Cháº¡y bá»™</h3>
 <input type="date" id="runDate"><br>
 <input type="number" id="kmInput" placeholder="Km">
 <input type="number" id="hInput" placeholder="Giá»">
 <input type="number" id="mInput" placeholder="PhÃºt">
 <button class="btn-add" id="addRunBtn">LÆ°u</button>
 <button class="btn-undo" id="undoRunBtn">HoÃ n tÃ¡c</button>
 <br><br>
 <input type="month" id="runMonth">
 <button id="runMonthBtn">ğŸ“Š Thá»‘ng kÃª thÃ¡ng</button>
 <div id="runDay"></div>
 <div id="runMonthBox" class="slide"></div>
 `;
 document.getElementById("runDate").value=new Date().toISOString().split("T")[0];
 document.getElementById("addRunBtn").onclick=addRun;
 document.getElementById("undoRunBtn").onclick=undoRun;
 document.getElementById("runMonthBtn").onclick=toggleRunMonth;
 updateRunDay();
}

function addRun(){
 const d=document.getElementById("runDate").value;
 if(!data.run[d]) data.run[d]={sessions:[]};
 data.run[d].sessions.unshift({
  km:+document.getElementById("kmInput").value||0,
  h:+document.getElementById("hInput").value||0,
  m:+document.getElementById("mInput").value||0
 });
 saveData();updateRunDay();
}

function undoRun(){
 const d=document.getElementById("runDate").value;
 if(data.run[d]?.sessions.length>0){
  data.run[d].sessions.shift();
  saveData();updateRunDay();
 }
}

function updateRunDay(){
 const d=document.getElementById("runDate").value;
 let totalKm=0,totalMin=0;
 if(data.run[d]){
  data.run[d].sessions.forEach(s=>{
   totalKm+=s.km;
   totalMin+=s.h*60+s.m;
  });
 }
 let H=Math.floor(totalMin/60),M=totalMin%60;
 document.getElementById("runDay").innerHTML=
 `<h4>${d}: ${totalKm} km | ${H}h ${M}p</h4>`;
}

function toggleRunMonth(){
 const box=document.getElementById("runMonthBox");
 const day=document.getElementById("runDay");

 box.classList.toggle("active");

 if(box.classList.contains("active")){
  day.style.display="none";
 }else{
  day.style.display="block";
 }

 updateRunMonth();
}

function updateRunMonth(){
 const m=document.getElementById("runMonth").value;
 if(!m)return;
 let totalKm=0,totalMin=0;
 Object.keys(data.run).forEach(d=>{
  if(d.startsWith(m)){
   data.run[d].sessions.forEach(s=>{
    totalKm+=s.km;
    totalMin+=s.h*60+s.m;
   });
  }
 });
 let H=Math.floor(totalMin/60),M=totalMin%60;
 document.getElementById("runMonthBox").innerHTML=
 `<h4>ğŸ”¥ ThÃ¡ng ${m}</h4>
 Tá»•ng: ${totalKm} km | ${H}h ${M}p`;
}

/* INIT */
window.onload=async()=>{
 if(localStorage.getItem("auth")==="true"){
  loginDiv.classList.add("hidden");
  appDiv.classList.remove("hidden");
 }
 await loadData();
};
</script>
</body>
</html>
