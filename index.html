<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Web c·ªßa H·ªØu Thi·ªán</title>

<style>
body{
    font-family:Arial;
    background:#0f0f0f;
    color:white;
    text-align:center;
    padding:30px 0;
    margin:0;
}
h2,h3,h4{margin:10px 0;}
button{
    padding:8px 14px;
    margin:5px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:bold;
}
.btn-main{background:#2196F3;color:white;}
.btn-add{background:#2ecc71;color:black;}
.btn-undo{background:#e67e22;color:black;}
.box{
    width:70%;
    margin:15px auto;
    background:#1a1a1a;
    padding:15px;
    border-radius:12px;
    border:1px solid #333;
    text-align:left;
}
input{
    padding:7px;
    margin:5px;
    background:#121212;
    border:1px solid #333;
    color:white;
    border-radius:6px;
}
.hidden{display:none;}
.slide{
    max-height:0;
    overflow:hidden;
    transition:max-height 0.4s ease;
}
.slide.active{max-height:2000px;}
.progress{background:#333;height:8px;border-radius:5px;}
.progress-bar{height:8px;border-radius:5px;background:#2ecc71;}
</style>
</head>
<body>

<div id="login">
<h2>üîê Nh·∫≠p m·∫≠t kh·∫©u</h2>
<input type="password" id="passInput">
<br><br>
<button onclick="login()">ƒêƒÉng nh·∫≠p</button>
<p id="loginError" style="color:red;"></p>
</div>

<div id="app" class="hidden">
<h2>üî• Web c·ªßa H·ªØu Thi·ªán</h2>
<button onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
<br><br>

<button class="btn-main" onclick="toggleBox('smokeBox')">üö¨ H√∫t thu·ªëc</button>
<button class="btn-main" onclick="toggleBox('runBox')">üèÉ Ch·∫°y b·ªô</button>

<div id="smokeBox" class="box hidden"></div>
<div id="runBox" class="box hidden"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig={
 apiKey:"AIzaSyDFgBUsVGUWoj-b2qGj4DyUpALlch2MSQ",
 authDomain:"bhtz-a7f60.firebaseapp.com",
 projectId:"bhtz-a7f60",
 storageBucket:"bhtz-a7f60.firebasestorage.app",
 messagingSenderId:"708884006477",
 appId:"1:708884006477:web:de2a3e37f6513d6676be04"
};

const appFB=initializeApp(firebaseConfig);
const db=getFirestore(appFB);

let data={smoke:{},run:{}};
const PASS="15102002";

/* LOGIN */
window.login=function(){
 if(passInput.value===PASS){
  localStorage.setItem("auth","true");
  login.classList.add("hidden");
  app.classList.remove("hidden");
 }else loginError.innerText="Sai m·∫≠t kh·∫©u!";
}
window.logout=function(){
 localStorage.removeItem("auth");
 location.reload();
}
function toggleBox(id){
 document.getElementById(id).classList.toggle("hidden");
}

/* FIREBASE */
async function loadData(){
 const snap=await getDoc(doc(db,"tracker","main"));
 if(snap.exists()) data=snap.data();
 if(!data.smoke) data.smoke={};
 if(!data.run) data.run={};
 renderSmoke();
 renderRun();
}
async function saveData(){
 await setDoc(doc(db,"tracker","main"),data);
}

/* SMOKE */
function renderSmoke(){
 smokeBox.innerHTML=`
 <h3>üö¨ H√∫t thu·ªëc</h3>
 <input type="date" id="smokeDate">
 <button class="btn-add" onclick="addSmoke()">Th√™m</button>
 <button class="btn-undo" onclick="undoSmoke()">Ho√†n t√°c</button>
 <br><br>
 <input type="month" id="smokeMonth">
 <button onclick="toggleSmokeMonth()">üìä Th·ªëng k√™ th√°ng</button>
 <div id="smokeDay"></div>
 <div id="smokeMonthBox" class="slide"></div>`;
 smokeDate.value=new Date().toISOString().split("T")[0];
 updateSmokeDay();
}

window.addSmoke=function(){
 let d=smokeDate.value;
 if(!data.smoke[d]) data.smoke[d]={count:0,history:[]};
 data.smoke[d].count++;
 data.smoke[d].history.unshift(new Date().toLocaleTimeString());
 saveData();updateSmokeDay();
}
window.undoSmoke=function(){
 let d=smokeDate.value;
 if(data.smoke[d]?.count>0){
  data.smoke[d].count--;
  data.smoke[d].history.shift();
  saveData();updateSmokeDay();
 }
}
function updateSmokeDay(){
 let d=smokeDate.value;
 let c=data.smoke[d]?.count||0;
 let html=`<h4>${d}: ${c} l·∫ßn</h4>`;
 if(data.smoke[d]){
  data.smoke[d].history.forEach((t,i)=>{
   html+=`<div>L·∫ßn ${data.smoke[d].history.length-i} - ${t}</div>`;
  });
 }
 smokeDay.innerHTML=html;
}
window.toggleSmokeMonth=function(){
 smokeMonthBox.classList.toggle("active");
 updateSmokeMonth();
}
function updateSmokeMonth(){
 let m=smokeMonth.value;if(!m)return;
 let total=0,html=`<h4>üî• Th√°ng ${m}</h4>`;
 for(let d in data.smoke){
  if(d.startsWith(m)){
   total+=data.smoke[d].count;
   html+=`<div>${d}: ${data.smoke[d].count} l·∫ßn</div>`;
  }
 }
 let goal=parseInt(localStorage.getItem("smokeGoal")||40);
 let percent=Math.min((total/goal)*100,100);
 html+=`
 <hr>
 <strong>T·ªïng th√°ng: ${total} l·∫ßn</strong><br>
 üéØ M·ª•c ti√™u ‚â§ ${goal} l·∫ßn
 <div class="progress"><div class="progress-bar" style="width:${percent}%"></div></div>
 <br>
 <input type="number" id="newSmokeGoal" placeholder="M·ª•c ti√™u m·ªõi">
 <button onclick="setSmokeGoal()">L∆∞u</button>
 `;
 smokeMonthBox.innerHTML=html;
}
window.setSmokeGoal=function(){
 localStorage.setItem("smokeGoal",newSmokeGoal.value);
 updateSmokeMonth();
}

/* RUN */
function renderRun(){
 runBox.innerHTML=`
 <h3>üèÉ Ch·∫°y b·ªô</h3>
 <input type="date" id="runDate"><br>
 <input type="number" id="kmInput" placeholder="Km">
 <input type="number" id="hourInput" placeholder="Gi·ªù">
 <input type="number" id="minInput" placeholder="Ph√∫t">
 <button class="btn-add" onclick="addRun()">L∆∞u</button>
 <button class="btn-undo" onclick="undoRun()">Ho√†n t√°c</button>
 <br><br>
 <input type="month" id="runMonth">
 <button onclick="toggleRunMonth()">üìä Th·ªëng k√™ th√°ng</button>
 <div id="runDay"></div>
 <div id="runMonthBox" class="slide"></div>`;
 runDate.value=new Date().toISOString().split("T")[0];
 updateRunDay();
}

window.addRun=function(){
 let d=runDate.value;
 if(!data.run[d]) data.run[d]={sessions:[]};
 data.run[d].sessions.unshift({
  km:+kmInput.value||0,
  h:+hourInput.value||0,
  m:+minInput.value||0,
  time:new Date().toLocaleTimeString()
 });
 saveData();updateRunDay();
}
window.undoRun=function(){
 let d=runDate.value;
 if(data.run[d]?.sessions.length>0){
  data.run[d].sessions.shift();
  saveData();updateRunDay();
 }
}
function updateRunDay(){
 let d=runDate.value;
 let totalKm=0,totalMin=0,html="";
 if(data.run[d]){
  data.run[d].sessions.forEach((s,i)=>{
   totalKm+=s.km;
   totalMin+=s.h*60+s.m;
   html+=`<div>Bu·ªïi ${data.run[d].sessions.length-i} - ${s.km}km | ${s.h}h ${s.m}p | ${s.time}</div>`;
  });
 }
 let H=Math.floor(totalMin/60),M=totalMin%60;
 runDay.innerHTML=`<h4>${d}: ${totalKm} km | ${H}h ${M}p</h4>`+html;
}
window.toggleRunMonth=function(){
 runMonthBox.classList.toggle("active");
 updateRunMonth();
}
function updateRunMonth(){
 let m=runMonth.value;if(!m)return;
 let totalKm=0,totalMin=0,days=[];
 for(let d in data.run){
  if(d.startsWith(m)){
   data.run[d].sessions.forEach(s=>{
    totalKm+=s.km;
    totalMin+=s.h*60+s.m;
   });
   days.push(d);
  }
 }
 let H=Math.floor(totalMin/60),M=totalMin%60;
 let goal=parseInt(localStorage.getItem("runGoal")||100);
 let percent=Math.min((totalKm/goal)*100,100);

 runMonthBox.innerHTML=`
 <h4>üî• Th√°ng ${m}</h4>
 <strong>T·ªïng: ${totalKm} km | ${H}h ${M}p</strong><br>
 üéØ M·ª•c ti√™u ${goal} km
 <div class="progress"><div class="progress-bar" style="width:${percent}%"></div></div>
 <br>
 <input type="number" id="newRunGoal" placeholder="M·ª•c ti√™u km">
 <button onclick="setRunGoal()">L∆∞u</button>
 `;
}
window.setRunGoal=function(){
 localStorage.setItem("runGoal",newRunGoal.value);
 updateRunMonth();
}

/* INIT */
window.onload=async()=>{
 if(localStorage.getItem("auth")==="true"){
  login.classList.add("hidden");
  app.classList.remove("hidden");
 }
 await loadData();
}
</script>
</body>
</html>
