<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üî• Tracker Cloud Pro</title>

<style>
body{
    font-family:Arial;
    text-align:center;
    margin-top:30px;
    background:#f4f6f9;
}
button{
    padding:8px 14px;
    margin:5px;
    border:none;
    border-radius:8px;
    cursor:pointer;
}
.btn-main{background:#2196F3;color:white;}
.btn-add{background:#4CAF50;color:white;}
.btn-undo{background:#ff9800;color:white;}
.box{
    width:65%;
    margin:auto;
    margin-top:15px;
    background:white;
    padding:12px;
    border-radius:8px;
    box-shadow:0 0 8px rgba(0,0,0,0.1);
    text-align:left;
}
input{padding:6px;margin:5px;}
.hidden{display:none;}
</style>
</head>
<body>

<h2>üî• Tracker Online Pro</h2>

<button id="smokeBtn" class="btn-main">üö¨ H√∫t thu·ªëc</button>
<button id="runBtn" class="btn-main">üèÉ Ch·∫°y b·ªô</button>

<div id="smokeBox" class="hidden box"></div>
<div id="runBox" class="hidden box"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* CONFIG FIREBASE */
const firebaseConfig = {
  apiKey: "AIzaSyDFgBUsVGUWoj-b2qGj4DyUpALlch2MSQ",
  authDomain: "bhtz-a7f60.firebaseapp.com",
  projectId: "bhtz-a7f60",
  storageBucket: "bhtz-a7f60.firebasestorage.app",
  messagingSenderId: "708884006477",
  appId: "1:708884006477:web:de2a3e37f6513d6676be04"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data = {};

/* LOAD */
async function loadData(){
    const snap = await getDoc(doc(db,"tracker","main"));
    if(snap.exists()) data = snap.data();
    renderSmoke();
    renderRun();
}

/* SAVE */
async function saveData(){
    await setDoc(doc(db,"tracker","main"), data);
}

/* ================= SMOKE ================= */

function renderSmoke(){

    document.getElementById("smokeBox").innerHTML=`
        <h3>üö¨ H√∫t thu·ªëc</h3>
        <input type="date" id="smokeDate">
        <button class="btn-add" onclick="addSmoke()">Th√™m 1 l·∫ßn</button>
        <button class="btn-undo" onclick="undoSmoke()">Ho√†n t√°c</button>
        <div id="smokeContent"></div>
    `;

    document.getElementById("smokeDate").value=new Date().toISOString().split("T")[0];
    updateSmokeUI();
}

function addSmoke(){
    const date=document.getElementById("smokeDate").value;
    if(!data.smoke) data.smoke={};
    if(!data.smoke[date]) data.smoke[date]={count:0,history:[]};

    data.smoke[date].count++;
    data.smoke[date].history.unshift(new Date().toLocaleTimeString());

    saveData();
    updateSmokeUI();
}

function undoSmoke(){
    const date=document.getElementById("smokeDate").value;
    if(data.smoke && data.smoke[date] && data.smoke[date].count>0){
        data.smoke[date].count--;
        data.smoke[date].history.shift();
        saveData();
        updateSmokeUI();
    }
}

function updateSmokeUI(){
    const date=document.getElementById("smokeDate").value;
    let html=`<h4>S·ªë l·∫ßn ng√†y ${date}: ${data.smoke?.[date]?.count||0}</h4>`;

    html+="<div>";
    if(data.smoke?.[date]){
        data.smoke[date].history.forEach((t,i)=>{
            html+=`<div>L·∫ßn ${data.smoke[date].history.length-i} - ${t}</div>`;
        });
    }
    html+="</div><h4>Th·ªëng k√™ c√°c ng√†y</h4>";

    for(let d in data.smoke){
        html+=`<div>${d} : ${data.smoke[d].count} l·∫ßn</div>`;
    }

    document.getElementById("smokeContent").innerHTML=html;
}

/* ================= RUN ================= */

function renderRun(){

    document.getElementById("runBox").innerHTML=`
        <h3>üèÉ Ch·∫°y b·ªô</h3>
        <input type="date" id="runDate">
        <br>
        <input type="number" id="kmInput" placeholder="Km">
        <input type="number" id="hourInput" placeholder="Gi·ªù">
        <button class="btn-add" onclick="addRun()">L∆∞u</button>
        <button class="btn-undo" onclick="undoRun()">Ho√†n t√°c</button>
        <div id="runContent"></div>
    `;

    document.getElementById("runDate").value=new Date().toISOString().split("T")[0];
    updateRunUI();
}

function addRun(){
    const date=document.getElementById("runDate").value;
    const km=parseFloat(document.getElementById("kmInput").value);
    const hour=parseFloat(document.getElementById("hourInput").value);
    if(!km||!hour) return;

    if(!data.run) data.run={};
    if(!data.run[date]) data.run[date]={sessions:[]};

    data.run[date].sessions.unshift({
        km:km,
        hour:hour,
        time:new Date().toLocaleTimeString()
    });

    saveData();
    updateRunUI();
}

function undoRun(){
    const date=document.getElementById("runDate").value;
    if(data.run?.[date]?.sessions.length>0){
        data.run[date].sessions.shift();
        saveData();
        updateRunUI();
    }
}

function updateRunUI(){
    const date=document.getElementById("runDate").value;
    let totalKm=0,totalHour=0;
    let html="";

    if(data.run?.[date]){
        data.run[date].sessions.forEach(s=>{
            totalKm+=s.km;
            totalHour+=s.hour;
        });

        html+=`<h4>T·ªïng ng√†y ${date}: ${totalKm} km | ${totalHour} gi·ªù</h4>`;

        data.run[date].sessions.forEach((s,i)=>{
            html+=`<div>Bu·ªïi ${data.run[date].sessions.length-i} - ${s.km} km | ${s.hour} gi·ªù | ${s.time}</div>`;
        });
    }else{
        html+=`<h4>T·ªïng ng√†y ${date}: 0 km | 0 gi·ªù</h4>`;
    }

    html+="<h4>Th·ªëng k√™ c√°c ng√†y</h4>";

    for(let d in data.run){
        let km=0,hr=0;
        data.run[d].sessions.forEach(s=>{
            km+=s.km; hr+=s.hour;
        });
        html+=`<div>${d} : ${km} km | ${hr} gi·ªù</div>`;
    }

    document.getElementById("runContent").innerHTML=html;
}

/* TOGGLE */
document.getElementById("smokeBtn").onclick=()=>{
    document.getElementById("smokeBox").classList.toggle("hidden");
};
document.getElementById("runBtn").onclick=()=>{
    document.getElementById("runBox").classList.toggle("hidden");
};

window.addSmoke=addSmoke;
window.undoSmoke=undoSmoke;
window.addRun=addRun;
window.undoRun=undoRun;

window.onload=loadData;

</script>
</body>
</html>
