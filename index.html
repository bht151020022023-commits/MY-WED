<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tracker Pro</title>

<style>
body{
    font-family:Arial;
    text-align:center;
    margin-top:30px;
    background:#f4f6f9;
}
button{
    padding:8px 14px;
    margin:5px;
    border:none;
    border-radius:8px;
    cursor:pointer;
}
.btn-main{background:#2196F3;color:white;}
.btn-add{background:#4CAF50;color:white;}
.btn-undo{background:#ff9800;color:white;}
.box{
    width:65%;
    margin:auto;
    margin-top:15px;
    background:white;
    padding:12px;
    border-radius:8px;
    box-shadow:0 0 8px rgba(0,0,0,0.1);
    text-align:left;
}
input{padding:6px;margin:5px;}
.hidden{display:none;}

.slideBox{
    max-height:0;
    overflow:hidden;
    transition:max-height 0.4s ease;
}
.slideBox.active{
    max-height:600px;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen" style="margin-top:100px;">
    <h2>üîê Nh·∫≠p m·∫≠t kh·∫©u</h2>
    <input type="password" id="passwordInput">
    <br><br>
    <button onclick="checkPassword()">ƒêƒÉng nh·∫≠p</button>
    <p id="loginError" style="color:red;"></p>
</div>

<!-- APP -->
<div id="appContent" style="display:none;">

<h2>üî• Tracker Online</h2>
<button onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
<br><br>

<button id="smokeBtn" class="btn-main">üö¨ H√∫t thu·ªëc</button>
<button id="runBtn" class="btn-main">üèÉ Ch·∫°y b·ªô</button>

<div id="smokeBox" class="hidden box"></div>
<div id="runBox" class="hidden box"></div>

</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc }
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

/* ================= FIREBASE ================= */

const firebaseConfig = {
  apiKey: "AIzaSyDFgBUsVGUWoj-b2qGj4DyUpALlch2MSQ",
  authDomain: "bhtz-a7f60.firebaseapp.com",
  projectId: "bhtz-a7f60",
  storageBucket: "bhtz-a7f60.firebasestorage.app",
  messagingSenderId: "708884006477",
  appId: "1:708884006477:web:de2a3e37f6513d6676be04"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data={};

/* ================= PASSWORD ================= */

const PASS="15102002";

function checkPassword(){
    if(document.getElementById("passwordInput").value===PASS){
        localStorage.setItem("auth","true");
        showApp();
    }else{
        document.getElementById("loginError").innerText="Sai m·∫≠t kh·∫©u!";
    }
}
function showApp(){
    document.getElementById("loginScreen").style.display="none";
    document.getElementById("appContent").style.display="block";
}
function logout(){
    localStorage.removeItem("auth");
    location.reload();
}

window.checkPassword=checkPassword;
window.logout=logout;

/* ================= FIRESTORE ================= */

async function loadData(){
    const snap=await getDoc(doc(db,"tracker","main"));
    if(snap.exists()) data=snap.data();
    if(!data.smoke) data.smoke={};
    if(!data.run) data.run={};
    renderSmoke();
    renderRun();
}
async function saveData(){
    await setDoc(doc(db,"tracker","main"),data);
}

/* ================= SMOKE ================= */

function renderSmoke(){
    document.getElementById("smokeBox").innerHTML=`
        <h3>üö¨ H√∫t thu·ªëc</h3>
        <input type="date" id="smokeDate">
        <button class="btn-add" onclick="addSmoke()">Th√™m</button>
        <button class="btn-undo" onclick="undoSmoke()">Ho√†n t√°c</button>

        <br><br>
        <input type="month" id="smokeMonth">
        <button onclick="toggleSmokeMonth()">üìä Th·ªëng k√™ th√°ng</button>

        <div id="smokeContent"></div>
        <div id="smokeMonthBox" class="slideBox"></div>
    `;
    document.getElementById("smokeDate").value=new Date().toISOString().split("T")[0];
    updateSmokeUI();
}

function addSmoke(){
    const d=document.getElementById("smokeDate").value;
    if(!data.smoke[d]) data.smoke[d]={count:0,history:[]};
    data.smoke[d].count++;
    data.smoke[d].history.unshift(new Date().toLocaleTimeString());
    saveData();
    updateSmokeUI();
}
function undoSmoke(){
    const d=document.getElementById("smokeDate").value;
    if(data.smoke[d]?.count>0){
        data.smoke[d].count--;
        data.smoke[d].history.shift();
        saveData();
        updateSmokeUI();
    }
}
function updateSmokeUI(){
    const d=document.getElementById("smokeDate").value;
    let html=`<h4>${d}: ${data.smoke[d]?.count||0} l·∫ßn</h4>`;
    if(data.smoke[d]){
        data.smoke[d].history.forEach((t,i)=>{
            html+=`<div>L·∫ßn ${data.smoke[d].history.length-i} - ${t}</div>`;
        });
    }
    document.getElementById("smokeContent").innerHTML=html;
}

function toggleSmokeMonth(){
    document.getElementById("smokeMonthBox").classList.toggle("active");
    updateSmokeMonth();
}
function updateSmokeMonth(){
    const m=document.getElementById("smokeMonth").value;
    if(!m) return;
    let total=0,html=`<h4>üî• Th√°ng ${m}</h4>`;
    for(let d in data.smoke){
        if(d.startsWith(m)){
            html+=`<div>üìÖ ${d}: ${data.smoke[d].count} l·∫ßn</div>`;
            total+=data.smoke[d].count;
        }
    }
    html+=`<hr><strong>T·ªïng: ${total} l·∫ßn</strong>`;
    document.getElementById("smokeMonthBox").innerHTML=html;
}

/* ================= RUN ================= */

function renderRun(){
    document.getElementById("runBox").innerHTML=`
        <h3>üèÉ Ch·∫°y b·ªô</h3>
        <input type="date" id="runDate"><br>
        <input type="number" id="kmInput" placeholder="Km">
        <input type="number" id="hourInput" placeholder="Gi·ªù">
        <input type="number" id="minuteInput" placeholder="Ph√∫t">
        <button class="btn-add" onclick="addRun()">L∆∞u</button>
        <button class="btn-undo" onclick="undoRun()">Ho√†n t√°c</button>

        <br><br>
        <input type="month" id="runMonth">
        <button onclick="toggleRunMonth()">üìä Th·ªëng k√™ th√°ng</button>

        <div id="runContent"></div>
        <div id="runMonthBox" class="slideBox"></div>
    `;
    document.getElementById("runDate").value=new Date().toISOString().split("T")[0];
    updateRunUI();
}

function addRun(){
    const d=document.getElementById("runDate").value;
    const km=parseFloat(document.getElementById("kmInput").value)||0;
    const h=parseInt(document.getElementById("hourInput").value)||0;
    const m=parseInt(document.getElementById("minuteInput").value)||0;
    if(!data.run[d]) data.run[d]={sessions:[]};
    data.run[d].sessions.unshift({km,hour:h,minute:m,time:new Date().toLocaleTimeString()});
    saveData();
    updateRunUI();
}
function undoRun(){
    const d=document.getElementById("runDate").value;
    if(data.run[d]?.sessions.length>0){
        data.run[d].sessions.shift();
        saveData();
        updateRunUI();
    }
}
function updateRunUI(){
    const d=document.getElementById("runDate").value;
    let totalKm=0,totalMin=0,html="";
    if(data.run[d]){
        data.run[d].sessions.forEach(s=>{
            totalKm+=s.km;
            totalMin+=s.hour*60+s.minute;
        });
        let h=Math.floor(totalMin/60);
        let m=totalMin%60;
        html+=`<h4>${d}: ${totalKm} km | ${h}h ${m}p</h4>`;
        data.run[d].sessions.forEach((s,i)=>{
            html+=`<div>Bu·ªïi ${data.run[d].sessions.length-i} - ${s.km}km | ${s.hour}h ${s.minute}p | ${s.time}</div>`;
        });
    }
    document.getElementById("runContent").innerHTML=html;
}

function toggleRunMonth(){
    document.getElementById("runMonthBox").classList.toggle("active");
    updateRunMonth();
}
function updateRunMonth(){
    const m=document.getElementById("runMonth").value;
    if(!m) return;
    let totalKm=0,totalMin=0,html=`<h4>üî• Th√°ng ${m}</h4>`;
    for(let d in data.run){
        if(d.startsWith(m)){
            let dayKm=0,dayMin=0;
            data.run[d].sessions.forEach(s=>{
                dayKm+=s.km;
                dayMin+=s.hour*60+s.minute;
            });
            let h=Math.floor(dayMin/60);
            let mm=dayMin%60;
            html+=`<div>üìÖ ${d}: ${dayKm} km | ${h}h ${mm}p</div>`;
            totalKm+=dayKm;
            totalMin+=dayMin;
        }
    }
    let H=Math.floor(totalMin/60);
    let M=totalMin%60;
    html+=`<hr><strong>T·ªïng th√°ng: ${totalKm} km | ${H}h ${M}p</strong>`;
    document.getElementById("runMonthBox").innerHTML=html;
}

/* ================= TOGGLE ================= */

document.getElementById("smokeBtn").onclick=()=>{
    document.getElementById("smokeBox").classList.toggle("hidden");
};
document.getElementById("runBtn").onclick=()=>{
    document.getElementById("runBox").classList.toggle("hidden");
};

/* ================= INIT ================= */

window.onload=async()=>{
    if(localStorage.getItem("auth")==="true") showApp();
    await loadData();
};

window.addSmoke=addSmoke;
window.undoSmoke=undoSmoke;
window.addRun=addRun;
window.undoRun=undoRun;
window.toggleSmokeMonth=toggleSmokeMonth;
window.toggleRunMonth=toggleRunMonth;

</script>
</body>
</html>
